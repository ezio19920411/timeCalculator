<!doctype html>
<html style="height:100%" ;>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Hit2_Boss重生計時</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
        integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.3.1.js"
        integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60=" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <style>
        .theme-popover-mask {
            z-index: 9998;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            opacity: 0.7;
            filter: alpha(opacity=40);
        }

        .theme-popover {
            z-index: 9999;
            position: fixed;
            top: 50%;
            left: 55%;
            width: 150px;
            height: 150px;
            margin: -180px 0 0 -330px;
            /* border-radius:5px; */
            /* border:solid 2px #666; */
            /* box-shadow: 0 0 10px #666; */
        }
    </style>
    <script>
        var bossData = new Object();
        var getTime = 1000;
        var getGSTime = 3000;
        var timeID = null;
        var timeIDGS = null;
        var ringUtil = null;
        var warnSW = false;
        var bossWarn = new Array();
        var bossPlace = new Array();
        var first_Open = true;
        var fastCopyLimit = 3;
        var dataTimetamp = "";
        var nowGroup = "all";
        var warn_min = 2;//warning min
        var voiceLang = "zh-tw";//念的語系
        function init() {


            var date = new Date(Date.now());
            document.getElementById("time_YYYY").value = date.getFullYear();
            document.getElementById("time_Mon").value = date.getMonth() + 1;
            document.getElementById("time_DD").value = date.getDate();
            document.getElementById("time_HH").value = date.getHours();
            document.getElementById("time_MM").value = date.getMinutes();

            document.getElementById("syc_time_YYYY").value = date.getFullYear();
            document.getElementById("syc_time_Mon").value = date.getMonth() + 1;
            document.getElementById("syc_time_DD").value = date.getDate();
            ringUtil = new ringSystem();
            ringUtil.setRingAudioAtr();
            getGSBossData();
            maskOpen("");

        }
        function doSomthing(data) {
            if (timeIDGS != null) clearTimeout(timeIDGS);
            var LSdata = JSON.parse(data);
            console.log(" dataTimetamp :" + dataTimetamp + " | LSdata :" + LSdata["timestamp"]);
            var isModify = false;
            var isRe = false;
            if (LSdata != "" && LSdata["2"]) {
                for (var key in bossData) {
                    if (key == "timestamp") {
                        if (dataTimetamp != "") {
                            if (!LSdata["timestamp"]) {
                                console.log("doSomthing [ LSdata " + LSdata["timestamp"] + " setGSBossData ]");
                                setGSBossData();
                                isRe = true;
                            }
                            if (LSdata["timestamp"] < dataTimetamp) {
                                console.log("doSomthing [ timestamp " + LSdata["timestamp"] + " <  dataTimetamp " + dataTimetamp + " setGSBossData ]");
                                setGSBossData();
                                isRe = true;
                            }
                        }
                        continue;
                    }
                    if (LSdata[key] && LSdata[key]["name"]) {
                        if (LSdata[key]["name"] != bossData[key]["name"]) isModify = true;
                    }
                }
            }
            if (isRe) return;
            if (first_Open || isModify) {
                for (var key in bossData) {
                    if (key == "timestamp") continue;
                    bossWarn[key] = false;
                }
                dataTimetamp = LSdata["timestamp"];
                bossData = LSdata;
                showGroup();
                resetAllSelect();
                first_Open = false;
                isModify = false;
            } else {
                dataTimetamp = LSdata["timestamp"];
                bossData = LSdata;
            }
            var boss_select_length = document.getElementById("boss_select").options.length;
            var mboss_select_length = document.getElementById("modify_boss_select").options.length;
            if (object_count(LSdata) - 1 != boss_select_length || object_count(LSdata) - 1 != mboss_select_length) resetAllSelect();
            getNowTime();
            // setLocalStorage("bossData_v2",JSON.stringify(data));

            timeIDGS = setTimeout(getGSBossData, getGSTime);
        }
        function resetAllSelect() {
            var boss_sele = document.getElementById("boss_select");
            var mboss_select = document.getElementById("modify_boss_select");
            boss_sele.options.length = 0;
            mboss_select.options.length = 0;
            for (var key in bossData) {
                if (key == "timestamp") continue;
                var tmp = bossData[key];
                boss_sele.options.add(new Option(tmp["name"], tmp["index"]));
                mboss_select.options.add(new Option(tmp["name"], tmp["index"]));
            }
            boss_select();
            modify_boss_select();

        }
        function getNowTime() {
            if (timeID != null) clearTimeout(timeID);
            var timeInMs = Date.now();
            var time_div = document.getElementById("text_now_time");
            var tmp_time = secTrancer(timeInMs);
            time_div.innerHTML = tmp_time;
            checkBossTime();
            timeID = setTimeout(getNowTime, getTime);
        }
        function show() {
            var btn_view = document.getElementById("btn_view");
            var show_view = document.getElementById("show_view");
            var show_fast_view = document.getElementById("show_fast_view");
            var btnXMP = document.getElementById("btnXMP").innerHTML;
            var btnXMP2 = document.getElementById("btnXMP2").innerHTML;
            var listXMP = document.getElementById("listXMP").innerHTML;
            var tmp_btn_v = "";
            var tmp_list_v = "";
            btn_view.innerHTML = "";
            show_view.innerHTML = "";
            show_fast_view.innerHTML = "";
            var funcNameAry = new Array();
            var bossAry = object_sort(bossData);
            var fastListStr = "";
            var fast_count = 0;
            for (key in bossData) {
                if (key == "timestamp") continue;
                if (key == "timehalfSW") continue;
                var tmp = btnXMP;
                var inner_btn = "";
                var tmp_data = bossData[key];
                var nowD = Date.now();

                if (nowGroup != "all") {
                    if (nowGroup != tmp_data["boss_group"]) {
                        continue;
                    }
                }
                tmp = tmp.replace(/\*ID\*/gi, tmp_data["index"]);
                tmp = tmp.replace(/\*BOSSNAME\*/gi, tmp_data["name"]);
                tmp = tmp.replace(/\*BORNTIME\*/gi, secTrancer(tmp_data["nextBorn"]));
                var btnclass = "primary";
                if (tmp_data["nextBorn"] != "" && (tmp_data["nextBorn"] - nowD) < warn_min * 60 * 1000) btnclass = "danger";
                if (tmp_data["nextBorn"] != "" && (nowD - (tmp_data["nextBorn"] - (tmp_data["rebornTime"] * 60 * 1000))) <= 10 * 60 * 1000) btnclass = "success";
                tmp = tmp.replace(/\*CLASS\*/gi, btnclass);

                var placeAry = bossPlace[tmp_data["index"]];
                console.log(tmp_data["bossPlace"] + tmp_data["name"]);
                if (tmp_data["bossPlace"].indexOf("|") != -1) {
                    placeAry = tmp_data["bossPlace"].split("|");
                }
                for (var key in placeAry) {
                    if (placeAry[key] == "") continue;
                    inner_btn += btnXMP2;
                    inner_btn = inner_btn.replace(/\*ID\*/gi, tmp_data["index"]);
                    inner_btn = inner_btn.replace(/\*PLACEID\*/gi, placeAry[key]);
                    inner_btn = inner_btn.replace(/\*PLACENAME\*/gi, placeAry[key]);
                }
                tmp = tmp.replace(/\*PLACEBTN\*/gi, inner_btn);
                tmp_btn_v += tmp;
            }

            for (var i = 0; i < bossAry.length; i++) {
                var tmp_data = bossAry[i];
                if (nowGroup != "all") {
                    if (nowGroup != tmp_data["boss_group"]) {
                        continue;
                    }
                }
                var tmp2 = listXMP;
                tmp2 = tmp2.replace(/\*BOSSNAME\*/gi, tmp_data["name"]);
                tmp2 = tmp2.replace(/\*BORNTIME\*/gi, secTrancer(tmp_data["nextBorn"]));
                // tmp2 = tmp2.replace(/\*BOSSPLACE\*/gi, (tmp_data["lastPlace"] != "無區分")? "最後位置:" + tmp_data["lastPlace"]:"");
                tmp2 = tmp2.replace(/\*BOSSPLACE\*/gi, "");
                tmp2 = tmp2.replace(/\*PASSCOUNT\*/gi, (tmp_data["passCount"]) ? "【過 " + tmp_data["passCount"] + " 】" : "");
                var textStylr = "";
                var textColor = "#FF0000";
                var textColor2 = "#9933ff";
                var tmp_SW = bossWarn[tmp_data["index"]];
                if (tmp_data["nextBorn"] != "" && (tmp_data["nextBorn"] - nowD) < warn_min * 60 * 1000) {
                    if (warnSW) {
                        if (!tmp_SW) {
                            console.log("open Ring");
                            ringUtil.playRing(5000, "1");
                            bossWarn[tmp_data["index"]] = true;
                        }
                        if (tmp_data["nextBorn"] != "" && (tmp_data["nextBorn"] - nowD) < 0.03 * 60 * 1000) {
                            //快到在停醒一次 6秒
                            if (warnSW) {
                                console.log("open Ring2");
                                ringUtil.playRing(1000, "2");
                                //瀏覽器語音
                                playAudioV2("voice_Name", voiceLang, tmp_data["name"] + " 即將出現");
                            }
                        }
                    }
                    textStylr = "background-color:Tomato;";
                    textColor = "#ffffff";
                    textColor2 = "#ffff66";
                } else {
                    if (tmp_SW) bossWarn[tmp_data["index"]] = false;
                }
                tmp2 = tmp2.replace(/\*STYLE\*/gi, textStylr);
                tmp2 = tmp2.replace(/\*COLOR\*/gi, textColor);
                tmp2 = tmp2.replace(/\*COLOR2\*/gi, textColor2);

                if (fast_count < fastCopyLimit) {
                    if (fastListStr != "") fastListStr += "➠";
                    var tmpT = secTrancer(tmp_data["nextBorn"]);
                    var tmpN = (tmp_data["name"].length > 3 && (tmp_data["name"].split("(") != -1)) ? tmp_data["name"].split("(")[0] : tmp_data["name"];
                    var tmpPass = (tmp_data["passCount"]) ? "[過" + tmp_data["passCount"] + "]" : "";
                    // var tmpPlace = (tmp_data["lastPlace"] != "無區分")? " " + tmp_data["lastPlace"]:"";
                    fastListStr += tmpT.split(" ")[1] + tmpN + tmpPass;
                }
                fast_count++;
                tmp_list_v += tmp2;
            }
            show_fast_view.innerHTML = fastListStr;
            btn_view.innerHTML = tmp_btn_v;
            show_view.innerHTML = tmp_list_v;

        }
        function setBossTime(key, place) {
            event.stopPropagation();
            var boss_D = bossData[key];
            var timeInMs = Date.now();
            var addsec = (boss_D["rebornTime"] * 60) * 1000;
            bossData[key]["nextBorn"] = timeInMs + addsec;
            if (place) bossData[key]["lastPlace"] = place;
            bossData[key]["passCount"] = 0;
            setGSBossData();
            maskOpen("");
            // setLocalStorage("bossData_v2",JSON.stringify(bossData));

        }
        function secTrancer(timestamp) {
            if (timestamp == "") return "-";
            var date = new Date(timestamp);
            var year = date.getFullYear();
            var month = (date.getMonth() + 1) + "";
            var day = date.getDate() + "";
            var hh = date.getHours() + "";
            var mm = date.getMinutes() + "";
            var ss = date.getSeconds() + "";

            var real_month = (month.length < 2) ? "0" + month : month;
            var real_day = (day.length < 2) ? "0" + day : day;
            var real_hh = (hh.length < 2) ? "0" + hh : hh;
            var real_mm = (mm.length < 2) ? "0" + mm : mm;
            var real_ss = (ss.length < 2) ? "0" + ss : ss;
            var tmp_time = year + "/" + real_month + "/" + real_day + " " + real_hh + ":" + real_mm + ":" + real_ss;

            return tmp_time;
        }
        function timeTrancer(daytime) {
            if (daytime == "") return "";
            var rs = "";
            var d = new Date(daytime);
            rs = d.getTime();

            return rs;
        }
        function editBossTime() {
            var dayTime = "";
            var time_YYYY = document.getElementById("time_YYYY").value;
            var time_Mon = document.getElementById("time_Mon").value;
            var time_DD = document.getElementById("time_DD").value;
            var time_HH = document.getElementById("time_HH").value;
            var time_MM = document.getElementById("time_MM").value;
            var time_SS = document.getElementById("time_SS").value;
            var boss_select = document.getElementById("boss_select").value;
            var place_select = document.getElementById("place_select").options[document.getElementById("place_select").selectedIndex].innerHTML;
            if (time_SS == "") time_SS = "000";
            dayTime = time_YYYY + "-" + time_Mon + "-" + time_DD + " " + time_HH + ":" + time_MM + ":" + time_SS;
            var timstamp = timeTrancer(dayTime);
            if (isNaN(timstamp)) {
                dayTime = time_YYYY + "/" + time_Mon + "/" + time_DD + " " + time_HH + ":" + time_MM + ":" + time_SS;
                timstamp = timeTrancer(dayTime);
            }
            // console.log(dayTime + " | " + timstamp);
            bossData[boss_select]["nextBorn"] = timstamp;
            bossData[boss_select]["lastPlace"] = place_select;
            bossData[boss_select]["passCount"] = 0;
            setGSBossData();
            maskOpen("");
            // setLocalStorage("bossData_v2",JSON.stringify(bossData));

        }
        function getLocalStorage() {
            var tmp_storage = null;
            try {
                tmp_storage = (window.localStorage) ? window.localStorage : window.globalStorage[strDomain];
                return tmp_storage;
            } catch (e) {
                return "";
            }
        }
        function getLocalStorageItem(_key) {
            var tmp_storage = getLocalStorage();
            return tmp_storage.getItem(_key);
        }
        function setLocalStorage(_key, _value) {
            var tmp_storage = getLocalStorage();
            tmp_storage.setItem(_key, _value);
        }
        function removeLocalStorage(_key) {
            var tmp_storage = getLocalStorage();
            tmp_storage.removeItem(_key);
            bossData = null;
            init();
        }
        function checkBossTime() {
            var isModify = false;
            for (key in bossData) {
                if (key == "timestamp") continue;
                if (key == "timehalfSW") continue;
                var tmp_BD = bossData[key];
                var BT = tmp_BD["nextBorn"];
                var loopSW = true;
                var nowD = Date.now();
                var addsec = (tmp_BD["rebornTime"] * 60 + tmp_BD["killTime"] * 60) * 1000;
                if (nowD > BT) {
                    while (loopSW) {
                        BT = BT * 1 + addsec;
                        if (BT > nowD) {
                            loopSW = false;
                            isModify = true;
                            tmp_BD["nextBorn"] = BT;
                            if (tmp_BD["passCount"]) {
                                tmp_BD["passCount"] = tmp_BD["passCount"] * 1 + 1;
                            } else {
                                tmp_BD["passCount"] = 1;
                            }
                        }
                    }
                }
            }
            // if(isModify)setGSBossData();
            // if(isModify)setLocalStorage("bossData",JSON.stringify(bossData));
            show();
        }
        function object_sort(obj) {
            var gmary = new Array();
            for (var key in obj) {
                if (key == "timestamp") continue;
                if (key == "timehalfSW") continue;
                gmary.push(obj[key]);
            }
            gmary = gmary.sort(function (a, b) { return a["nextBorn"] - b["nextBorn"]; });

            return gmary;
        }
        function object_count(obj) {
            var count = 0;
            for (var key in obj) {
                count++;

            }
            return count;
        }
        function getBossData() {
            var msg_text = document.getElementById("msg_text");
            var tmpD = getLocalStorageItem("bossData_v2");
            msg_text.value = tmpD;
        }
        function setBossData() {
            var msg_text = document.getElementById("msg_text");

            if (msg_text.value == "") {
                $('#alert_text').text("請勿匯入空白資料!");
                $('#btnTrigger').click();
                return;
            }

            var tmp_Obj = JSON.parse(msg_text.value);
            if (typeof (tmp_Obj) != "object") {
                $('#alert_text').text("資料格式錯誤!");
                $('#btnTrigger').click();
                return;
            }

            setLocalStorage("bossData_v2", JSON.stringify(tmp_Obj));
            bossData = tmp_Obj;
            checkBossTime();
        }
        function doCopy(divID) {
            var copyDiv = document.getElementById(divID);
            if (window.clipboardData) {
                window.clipboardData.setData("Text", copyDiv.innerHTML);
                $('#alert_text').text("Copy Success!");
                $('#btnTrigger').click();
            }
            else if (document.createRange && window.getSelection) {
                var range = document.createRange();
                range.selectNode(copyDiv);
                var sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(range);
                document.execCommand("Copy", false, null);
                sel.removeAllRanges();
                $('#alert_text').text("Copy Success!");
                $('#btnTrigger').click();

            } else {
                $('#alert_text').text("erro_Copy");
                $('#btnTrigger').click();
            }
        }
        function ringSystem() {
            var self = this;
            self.setRingAudioAtr = function () {
                var ring = document.getElementById("ring_audio1");
                var ring2 = document.getElementById("ring_audio2");
                ring.setAttribute("type", "audio/mpeg");
                ring.setAttribute("Loop", "Loop");
                ring2.setAttribute("type", "audio/mpeg");
                ring2.setAttribute("Loop", "Loop");
            }

            self.playRing = function (closeTime, type) {
                console.log("is Ring " + closeTime);
                var ring = document.getElementById("ring_audio" + type);
                ring.play();
                setTimeout("ringUtil.stopRing(" + type + ")", closeTime);
            }

            self.stopRing = function (type) {
                console.log("close close");
                var ring = document.getElementById("ring_audio" + type);
                if (!ring) return;
                ring.pause();
                ring.load();
            }
        }
        function warningSW() {
            var warnPic = document.getElementById("warnPic");
            var warnText = document.getElementById("warnText");
            if (warnSW) {
                warnPic.classList.remove("glyphicon-volume-up");
                warnPic.classList.add("glyphicon-volume-off");
                warnSW = false;
                warnText.innerHTML = "Warning Off";
            } else {
                warnPic.classList.remove("glyphicon-volume-off");
                warnPic.classList.add("glyphicon-volume-up");
                warnSW = true;
                warnText.innerHTML = "Warning Open";
            }
        }
        function boss_select() {
            var boss_select = document.getElementById("boss_select");
            var place_select = document.getElementById("place_select");
            var tmp_index = boss_select.value;
            place_select.options.length = 0;
            var placeAry = (bossData[tmp_index]["bossPlace"].indexOf("|") != -1) ? bossData[tmp_index]["bossPlace"].split("|") : "";
            if (placeAry == "") place_select.options.add(new Option("無區分", 0));
            else {
                for (var key in placeAry) {
                    var tmp = placeAry[key];
                    place_select.options.add(new Option(tmp, key));
                }
            }
        }
        function modify_boss_select() {
            var boss_select = document.getElementById("modify_boss_select");
            var tmp_index = boss_select.value;
            var placeAry = (bossData[tmp_index]["bossPlace"].indexOf("|") != -1) ? bossData[tmp_index]["bossPlace"].split("|") : "";
            document.getElementById("modify_boss_name").value = bossData[tmp_index]["name"];
            document.getElementById("modify_boss_place").value = bossData[tmp_index]["bossPlace"];
            document.getElementById("modify_boss_rebornTime").value = bossData[tmp_index]["rebornTime"];
            document.getElementById("modify_boss_killTime").value = bossData[tmp_index]["killTime"];
            document.getElementById("modify_boss_group").value = (bossData[tmp_index]["boss_group"]) ? bossData[tmp_index]["boss_group"] : "";

        }
        function resetAllTime() {
            if (confirm("確定今天星期三要重置了嗎?")) {
                for (var key in bossData) {
                    if (key == "timestamp") continue;
                    if (key == "timehalfSW") continue;
                    var boss_D = bossData[key];
                    var date = new Date(Date.now());
                    var year = date.getFullYear();
                    var month = (date.getMonth() + 1) + "";
                    var day = date.getDate() + "";
                    var dayTime = "";
                    dayTime = year + "-" + month + "-" + day + " 05:50:00";
                    var timstamp = timeTrancer(dayTime);
                    if (isNaN(timstamp)) {
                        dayTime = year + "/" + month + "/" + day + " 05:50:00";
                        timstamp = timeTrancer(dayTime);
                    }
                    bossData[key]["nextBorn"] = timstamp;
                    bossData[key]["passCount"] = 0;
                }
                console.log(bossData);
                setGSBossData();
                maskOpen("");
            } else {
                return;
            }
        }

            function getGSBossData() {
                $.ajax({
                    url: "https://script.google.com/macros/s/AKfycbyHQJxY7rke3crnWPvSmKFLpJqVTVZvlcWaOnurpmiZbi4am3LMgBSOL3gIHKWmT8hD/exec",
                    type: "POST",
                    success: function (response) {
                        // console.log("success");
                        doSomthing(response);
                        maskOpen("none");
                    },
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
                    },
                });
            }
            function setGSBossData() {
                bossData["timestamp"] = Date.now();
                dataTimetamp = bossData["timestamp"];
                var name = JSON.stringify(bossData);
                $.ajax({
                    type: "POST",
                    url: "https://script.google.com/macros/s/AKfycbyMywEdiACF3L2XKg5aTOWnWo7LbqA52yaDeQG4eIvHzLxAgeLRrZ0QErmTCxJxwP7D/exec",
                    data: {
                        "name": name,
                    },
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
                    },
                    success: function (response) {
                        if (response == "成功") {
                            console.log(response);
                            // resetAllSelect();
                            setTimeout(getGSRoomData, 1000);
                        }
                    },
                });
            };
            function addGSBossData() {
                var name = JSON.stringify(bossData);
                $.ajax({
                    type: "POST",
                    url: "https://script.google.com/macros/s/AKfycbyMywEdiACF3L2XKg5aTOWnWo7LbqA52yaDeQG4eIvHzLxAgeLRrZ0QErmTCxJxwP7D/exec",
                    data: {
                        "name": name,
                    },
                    success: function (response) {
                        if (response == "成功") {
                            document.getElementById("add_boss_name").value = "";
                            document.getElementById("add_boss_place").value = "";
                            document.getElementById("add_boss_rebornTime").value = "";
                            document.getElementById("add_boss_killTime").value = "";
                            getGSRoomData();
                        }
                    },
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
                    },
                });
            };

        function addBossData() {
            var add_boss_name = document.getElementById("add_boss_name").value;
            var add_boss_place = document.getElementById("add_boss_place").value;
            var add_boss_rebornTime = document.getElementById("add_boss_rebornTime").value;
            var add_boss_killTime = document.getElementById("add_boss_killTime").value;
            var add_boss_group = document.getElementById("add_boss_group").value;

            if (add_boss_name == "" || add_boss_rebornTime == "") {
                $('#alert_text').text("名稱 / 重生時間 不能為空!");
                $('#btnTrigger').click();
                return;
            }
            if (add_boss_group == "all") {
                $('#alert_text').text("群組不能為 all");
                $('#btnTrigger').click();
                return;
            }
            var nowCount = object_count(bossData);
            var tmp_D = new Object;
            tmp_D["index"] = nowCount + 1;
            tmp_D["name"] = add_boss_name;
            tmp_D["rebornTime"] = add_boss_rebornTime;
            tmp_D["nextBorn"] = "";
            tmp_D["killTime"] = (add_boss_killTime == "") ? "0" : add_boss_killTime;
            tmp_D["lastPlace"] = "";
            tmp_D["bossPlace"] = (add_boss_place == "") ? "0" : add_boss_place;
            tmp_D["boss_group"] = add_boss_group;


            bossData[tmp_D["index"]] = tmp_D;
            addGSBossData();
            maskOpen("");
        }
        function modifyBossTime() {
            var index = document.getElementById("modify_boss_select").value;
            var name = document.getElementById("modify_boss_name").value;
            var place = document.getElementById("modify_boss_place").value;
            var rebornTime = document.getElementById("modify_boss_rebornTime").value;
            var killTime = document.getElementById("modify_boss_killTime").value;
            var boss_group = document.getElementById("modify_boss_group").value;

            if (rebornTime == "" || name == "") {
                $('#alert_text').text("名稱/重生時間 不可為空白!");
                $('#btnTrigger').click();
                return;
            }
            if (boss_group == "all") {
                $('#alert_text').text("群組不能為 all");
                $('#btnTrigger').click();
                return;
            }
            bossData[index]["name"] = name;
            bossData[index]["bossPlace"] = place;
            bossData[index]["rebornTime"] = rebornTime;
            bossData[index]["killTime"] = (killTime == "") ? "0" : killTime;
            bossData[index]["boss_group"] = boss_group;
            setGSBossData();
            maskOpen("");
        }
        function deleteBossTime() {
            var index = document.getElementById("modify_boss_select").value;
            delete bossData[index];
            setGSBossData();
            maskOpen("");
        }
        function maskOpen(disstr) {
            var mask = document.getElementById("loading_mask");
            mask.style.display = disstr;
        }
        function sycBossData() {
            var fast_syc = document.getElementById("fast_syc").value;
            if (fast_syc == "") {
                $('#alert_text').text("同步資料 不能為空!");
                $('#btnTrigger').click();
                return;
            }
            if (fast_syc.indexOf("  ") != -1) {
                var big_fast = fast_syc.split("  ");
                for (var i = 0; i < big_fast.length; i++) {
                    console.log(big_fast[i]);
                    setSynBossData(big_fast[i]);
                }
            } else {
                console.log(fast_syc);
                setSynBossData(fast_syc);
            }
            setGSBossData();
            maskOpen("");
        }
        function setSynBossData(fast_syc) {
            var dayTime = "";
            var tmp_d = fast_syc.split(" ");
            var tmp_t = tmp_d[0].split(":");
            var boss_select = "";
            var time_YYYY = document.getElementById("syc_time_YYYY").value;
            var time_Mon = document.getElementById("syc_time_Mon").value;
            var time_DD = document.getElementById("syc_time_DD").value;

            var time_HH = tmp_t[0];
            var time_MM = tmp_t[1];
            var time_SS = tmp_t[2];

            for (var key in bossData) {
                var tmpD = bossData[key];
                if (tmpD["name"] == tmp_d[1]) {
                    boss_select = tmpD["index"];
                    break;
                }
            }
            if (boss_select == "") {
                $('#alert_text').text("查無資料 請確認資料是否正確!");
                $('#btnTrigger').click();
                return;
            }
            if (time_SS == "") time_SS = "000";
            dayTime = time_YYYY + "-" + time_Mon + "-" + time_DD + " " + time_HH + ":" + time_MM + ":" + time_SS;
            var timstamp = timeTrancer(dayTime);
            if (isNaN(timstamp)) {
                dayTime = time_YYYY + "/" + time_Mon + "/" + time_DD + " " + time_HH + ":" + time_MM + ":" + time_SS;
                timstamp = timeTrancer(dayTime);
            }
            var passCount = 0;
            if (tmp_d[2]) {
                passCount = tmp_d[2].substring(tmp_d[2].lastIndexOf("】") - 1, tmp_d[2].lastIndexOf("】"));
            }
            console.log(dayTime + " | " + timstamp + " | " + passCount);
            bossData[boss_select]["nextBorn"] = timstamp;
            bossData[boss_select]["passCount"] = passCount;
        }
        function showGroup() {
            var group_div = document.getElementById("group_div");
            var li_XMP = document.getElementById("li_XMP").innerHTML;
            var groupAry = new Object();
            var gstr = "";
            group_div.innerHTML = "";
            for (var key in bossData) {
                var tmpD = bossData[key];
                if (tmpD["boss_group"]) groupAry[tmpD["boss_group"]] = "";
            }

            gstr += li_XMP;
            gstr = gstr.replace(/\*GROUPNAME\*/gi, "all");
            gstr = gstr.replace(/\*class\*/gi, "active");

            for (key in groupAry) {
                gstr += li_XMP;
                gstr = gstr.replace(/\*GROUPNAME\*/gi, key);
                gstr = gstr.replace(/\*class\*/gi, "");
            }
            group_div.innerHTML = gstr;

        }
        function groupSW(e) {
            console.log(e.getAttribute("data-value"));
            nowGroup = e.getAttribute("data-value");
            var group_div = document.getElementById("group_div");
            for (var i = 0; i < group_div.children.length; i++) {
                var tmp_Div = group_div.children[i];
                tmp_Div.classList.remove("active");
            }
            e.classList.add("active");
        }
        function playAudioV2(voiceName, langx, text) {
            var synth = window.speechSynthesis;
            var voices = [];

            if (!synth) {
                console.error('speechSynthesis null');
                return;
            }

            if (synth.speaking) {
                // console.error('speechSynthesis.speaking');
                // return;
            }

            function reset() {
                voices = synth.getVoices();
            }
            reset();
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = reset;
            }
            if (text !== '') {
                voices = synth.getVoices();
                var utterThis = new SpeechSynthesisUtterance(text);
                utterThis.onend = function (event) {
                    console.log('SpeechSynthesisUtterance.onend');
                }
                utterThis.onerror = function (event) {
                    console.error('SpeechSynthesisUtterance.onerror');
                }
                utterThis.pitch = 1;
                utterThis.rate = 0.75;
                utterThis.lang = langx;
                for (var i = 0; i < voices.length; i++) {

                    if (voices[i].name === voiceName && voices[i].lang.toLowerCase() == langx) {
                        // console.log(voiceName, langx);
                        utterThis.voice = voices[i];
                        break;
                    } else if (voices[i].lang.toLowerCase() == langx) {
                        utterThis.voice = voices[i];
                    }
                }
                synth.speak(utterThis);
            }
        }
    </script>
</head>

<body onload="init();" style="height:100%;">
    <div class="row">
        <div class="col-sm-4">
            <div class="panel panel-default">
                <div class="panel-heading">
                    現在時間 : <h3 id="text_now_time"></h3>
                    <ul class="nav nav-tabs" id="group_div"></ul>
                </div>
                <button type="button" class="btn btn-default" onclick="doCopy('show_fast_view')">
                    <span class="glyphicon glyphicon-duplicate"></span> Copy Top List
                </button>
                <button type="button" class="btn btn-default" onclick="doCopy('show_view')">
                    <span class="glyphicon glyphicon-duplicate"></span> Copy All List
                </button>
                <button type="button" class="btn btn-default" onclick="warningSW()">
                    <span class="glyphicon glyphicon-volume-off" id="warnPic"></span>
                    <span id="warnText">Warning Off</span>
                </button>
                <button type="button" class="btn btn-default" onclick="resetAllTime()" style="display:none">
                    <span class="glyphicon glyphicon-retweet" id="warnPic"></span> Reset All time
                </button>

                <div id="show_fast_view" style="margin:20px"></div>
            </div>
        </div>
        <div class="col-sm-6">
            <div class="">
                <h3>設定時間</h3>
                <table class="table">
                    <thead>
                        <tr>
                            <th>
                                BOSS名稱:
                                <select class="form-control" id="boss_select" onchange="boss_select()"></select>
                            </th>
                            <th>
                                最後位置:
                                <select class="form-control" id="place_select"></select>
                            </th>
                            <th><button type="button" class="btn btn-success" onclick="editBossTime()">修改</button></th>
                        </tr>
                    </thead>
                </table>


                <table class="table">
                    <thead>
                        <tr>
                            <th>Year</th>
                            <th>Mon</th>
                            <th>Day</th>
                            <th>Hr</th>
                            <th>Min</th>
                            <th>Sec</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><input type="text" class="form-control" id="time_YYYY"></td>
                            <td><input type="text" class="form-control" id="time_Mon"></td>
                            <td><input type="text" class="form-control" id="time_DD"></td>
                            <td><input type="text" class="form-control" id="time_HH"></td>
                            <td><input type="text" class="form-control" id="time_MM"></td>
                            <td><input type="text" class="form-control" id="time_SS" placeholder="000"></td>
                        </tr>
                    </tbody>
                </table>

            </div>

            <div style="display:none;">
                <div class="input-group">
                    <span class="input-group-addon">Text</span>
                    <input id="msg_text" type="text" class="form-control" name="msg" placeholder="Data is here">
                </div>
                <button type="button" class="btn btn-info" onclick="getBossData()">匯出資料</button>
                <button type="button" class="btn btn-warning" onclick="setBossData()">匯入資料</button>
                <button type="button" class="btn btn-default " onclick="doCopy('msg_text')">
                    <span class="glyphicon glyphicon-copy"></span> Copy Text
                </button>
            </div>
        </div>

    </div>
    <div class="row">
        <div class="panel panel-default col-lg-4" id="show_view"></div>
        <div id="btn_view" style="" class="col-lg-8 btn-group"></div>
        <div id="" style="" class="col-lg-6">
            <div class="">
                <h3>新增資料</h3>
                <table class="table">
                    <thead>
                        <tr>
                            <th>
                                BOSS名稱:
                                <input type="text" class="form-control" id="add_boss_name">
                            </th>
                            <th>
                                出生位置:(範例: 上|中|下 )
                                <input type="text" class="form-control" id="add_boss_place">
                            </th>
                            <th>
                                重生時間:(單位分鐘)
                                <input type="text" class="form-control" placeholder="0" id="add_boss_rebornTime">
                            </th>
                            <th>
                                修正時間:(單位分鐘)
                                <input type="text" class="form-control" placeholder="0" id="add_boss_killTime">
                            </th>
                            <th>
                                群組:
                                <input type="text" class="form-control" id="add_boss_group">
                            </th>
                            <th><button type="button" class="btn btn-success" onclick="addBossData()">新增</button></th>
                        </tr>
                    </thead>
                </table>

                <h3>修改/刪除資料</h3>
                <table class="table">
                    <thead>
                        <tr>
                            <th>
                                BOSS名稱:
                                <select class="form-control" id="modify_boss_select"
                                    onchange="modify_boss_select()"></select>
                            </th>
                            <th><button type="button" class="btn btn-warning" onclick="modifyBossTime()">修改</button>
                            </th>
                            <th><button type="button" class="btn btn-danger" onclick="deleteBossTime()">刪除</button></th>
                        </tr>
                    </thead>
                </table>
                <table class="table">
                    <thead>
                        <tr>
                            <th>名稱</th>
                            <th>出生位置</th>
                            <th>重生時間</th>
                            <th>修正時間</th>
                            <th>群組</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><input type="text" class="form-control" id="modify_boss_name"></td>
                            <td><input type="text" class="form-control" id="modify_boss_place"></td>
                            <td><input type="text" class="form-control" id="modify_boss_rebornTime"></td>
                            <td><input type="text" class="form-control" id="modify_boss_killTime" placeholder="0"></td>
                            <td><input type="text" class="form-control" id="modify_boss_group"></td>
                        </tr>
                    </tbody>
                </table>
                <h3>快速同步</h3>
                <table class="table">
                    <thead>
                        <tr>
                            <th>
                                Year
                                <input type="text" class="form-control" placeholder="0" id="syc_time_YYYY">
                            </th>
                            <th>
                                Mon
                                <input type="text" class="form-control" placeholder="0" id="syc_time_Mon">
                            </th>
                            <th>
                                Day
                                <input type="text" class="form-control" placeholder="0" id="syc_time_DD">
                            </th>
                            <th>
                                時間 名稱(範例=>20:20:20 太平間)
                                <input type="text" class="form-control" id="fast_syc">
                            </th>
                            <th><button type="button" class="btn btn-success" onclick="sycBossData()">送出</button></th>
                        </tr>
                    </thead>
                </table>
            </div>
        </div>
    </div>
    </div>
    <div id="copy_area"></div>
    <audio id="ring_audio1">
        <source src="./warnig.mp3">
    </audio>
    <audio id="ring_audio2">
        <source src="./katana1.mp3">
    </audio>
    <div id="loading_mask" style="display:none;">
        <div class="theme-popover-mask"></div>
        <div class="theme-popover">
            <img src="./loading.gif">
        </div>
    </div>
    <button style="display:none" type="button" class="btn btn-info btn-lg" data-toggle="modal" data-target="#myModal"
        id="btnTrigger"></button>
    <!-- Modal -->
    <div class="modal fade" id="myModal" role="dialog">
        <div class="modal-dialog">

            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <!-- <h4 class="modal-title">System Massage</h4> -->
                </div>
                <div class="modal-body">
                    <h3 id="alert_text">Copy Success !</h3>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>

        </div>
    </div>
    <div style="display:none">
        <xmp id="btnXMP">
            <div class="btn btn-*CLASS* btn-lg" onclick="setBossTime(*ID*,'')" style="height: 120px;"
                id="btn_boss_*ID*">
                *BOSSNAME*
                <h4>*BORNTIME*</h4>
                <div class="btn-group">*PLACEBTN*</div>
            </div>
        </xmp>
        <xmp id="listXMP">
            <div class="panel-body" style="*STYLE*">
                <font color="*COLOR*" size="5">*BORNTIME*</font>
                <font size="3">*BOSSNAME*</font>
                <font size="3" color="*COLOR2*">*BOSSPLACE*</font>
                <font size="3">*PASSCOUNT*</font>
            </div>
        </xmp>
        <xmp id="btnXMP2">
            <button type="button" class="btn btn-default" onclick="setBossTime(*ID*,'*PLACEID*')">*PLACENAME*</button>
        </xmp>
        <xmp id="li_XMP">
            <li class="*CLASS*" onclick="groupSW(this)" data-value="*GROUPNAME*"><a href="#">*GROUPNAME*</a></li>
        </xmp>
    </div>
</body>

</html>